<div class="dashboard-container">
  <app-header placeholder="" [breadcrumb]="true" [export]="true"></app-header>

  <div class="content">
    <!-- ✅ Résumé des statistiques (avec la nouvelle carte "Valeur des kits") -->
    <div class="overview-card">
      @for (resume of resumes$ | async; track resume.name) {
        <div class="stat">
          <span class="stat-title">{{ resume.name }}</span>
          <span class="stat-value">{{ resume.value }}</span>
          <span class="hint">{{ resume.monthlyValue }}</span>
        </div>
      }
    </div>

    <!-- Boutons d'actions -->
    <div class="actions-buttons">
      <button routerLink="/planters/new" class="action-button">
        <mat-icon class="button-icon">person_add</mat-icon>
        <span>Ajouter un planteur</span>
      </button>
      <button routerLink="/plantations/add" class="action-button">
        <i class="fas fa-tractor button-icon"></i>
        <span>Ajouter une plantation</span>
      </button>
      <button routerLink="/productions/add" class="action-button">
        <i class="fas fa-wheat-awn button-icon"></i>
        <span>Ajouter une production</span>
      </button>
    </div>

    <div class="graphics">
      <div class="grid">
        <!-- ✨ MODIFIÉ : Production par secteur avec filtre année -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Production par secteur</span>
            <div class="filter-group">
              <mat-form-field appearance="outline" class="filter-select">
                <mat-label>Année</mat-label>
                <mat-select [(value)]="selectedYearFilter" (selectionChange)="onYearFilterChange()">
                  <mat-option [value]="0">Toutes les années</mat-option>
                  @for (year of availableYears; track year) {
                    <mat-option [value]="year">{{ year }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              @if (selectedYearFilter) {
                <button mat-icon-button (click)="resetYearFilter()" class="reset-button" title="Réinitialiser">
                  <mat-icon>close</mat-icon>
                </button>
              }
            </div>
          </div>
          <div class="chart">
            <canvas #barCanvas [style.display]="productionBySector && productionBySector.length > 0 ? 'block' : 'none'"></canvas>

            @if (!productionBySector || productionBySector.length === 0) {
              <div class="chart-loading">
                <mat-spinner diameter="24"></mat-spinner>
                <span>Chargement des données...</span>
              </div>
            }
          </div>
        </div>

        <!-- Production par plantation (inchangé) -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Production par plantation</span>
          </div>
          <div class="chart">
            <canvas #pieCanvas [style.display]="productionByPlantation.length > 0 ? 'block' : 'none'"></canvas>

            @if (productionByPlantation.length === 0) {
              <div class="chart-loading">
                <mat-spinner diameter="24"></mat-spinner>
                <span>Chargement des données...</span>
              </div>
            }
          </div>
        </div>
      </div>

      <div class="col">
        <!-- ✨ MODIFIÉ : Tendance de production par année (au lieu de 12 derniers mois) -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Tendance de production</span>
            <div class="card-subtitle">Évolution par année</div>
          </div>
          <div class="chart">
            <canvas #lineCanvas [style.display]="productionTrend.length > 0 ? 'block' : 'none'"></canvas>

            @if (productionTrend.length === 0) {
              <div class="chart-loading">
                <mat-spinner diameter="24"></mat-spinner>
                <span>Chargement des données...</span>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
