<div class="add-plantation-container">
  <app-header placeholder="" [breadcrumb]="true" [export]="false"></app-header>

  <div class="content">
    <div class="page-header">
      <span>{{ editMode ? 'Modifier une plantation' : 'Ajouter une plantation' }}</span>
    </div>

    <form [formGroup]="plantationForm">
      <div class="grid grid--two-fs">

        <!-- Informations de la parcelle -->
        <div class="card">
          <div class="section-title">
            Informations de la parcelle
          </div>

          <div class="form-grid">
            <div class="field" style="margin-bottom: 1.3rem">
              <mat-form-field appearance="outline">
                <mat-label>Village de la parcelle</mat-label>
                <input matInput type="text" formControlName="name">
                <mat-hint>Si aucune information n'est saisie, le nom récupéré par les coordonnées sera utilisé</mat-hint>
              </mat-form-field>
            </div>

            <div class="field">
              <mat-form-field appearance="outline" suffix="ha">
                <mat-label>Superficie (ha)</mat-label>
                <input matInput type="number" step="0.1" min="0.1" formControlName="farmedArea" required>
                @if (plantationForm.get('farmedArea')?.hasError('required')){
                  <mat-error>La superficie est requise</mat-error>
                } @else if (plantationForm.get('farmedArea')?.hasError('min')) {
                  <mat-error>La superficie doit être supérieure à 0,1 ha</mat-error>
                }
              </mat-form-field>
            </div>
            <div class="field">
              <mat-form-field appearance="outline">
                <mat-label>Planteur</mat-label>
                <mat-select formControlName="planterId" (selectionChange)="onPlanterChange($event.value)" required>
                  @for (planter of (planters$ | async); track planter.id) {
                    <mat-option [value]="planter.id">
                      {{planter.firstname}} {{planter.lastname}}
                    </mat-option>
                  }
                </mat-select>
                @if (plantationForm.get('planterId')?.hasError('required')) {
                  <mat-error>Veuillez sélectionner un planteur</mat-error>
                }
              </mat-form-field>
            </div>
            <div class="field">
              <mat-form-field appearance="outline">
                <mat-label>Secteur</mat-label>
                <input matInput type="text" formControlName="sector" required>
                @if (plantationForm.get('sector')?.hasError('required')) {
                  <mat-error>Le secteur est requis</mat-error>
                }
              </mat-form-field>
            </div>
          </div>

          <div class="field">
            <mat-form-field appearance="outline">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" rows="6"></textarea>
            </mat-form-field>
          </div>
        </div>

        <!-- Localisation -->
        <div class="card">
          <div class="section-title">
            Localisation
          </div>

          <div class="field">
            <mat-form-field appearance="outline">
              <mat-label>Coordonnées GPS</mat-label>
              <input matInput type="text" [formControl]="gpsCtrl" placeholder="Latitude, Longitude" required>
              <mat-hint>Format: latitude, longitude (ex: 5.3600, -4.0083)</mat-hint>
              @if (gpsCtrl.hasError('required')){
                <mat-error>Les coordonnées GPS sont requises</mat-error>
              } @else if (gpsCtrl.hasError('invalidFormat')){
                <mat-error>
                  Format invalide. Utilisez: latitude, longitude
                </mat-error>
              } @else if (gpsCtrl.hasError('invalidCoordinates')){
                <mat-error>Coordonnées invalides</mat-error>
              } @else if (gpsCtrl.hasError('outOfRange')){
                <mat-error>Coordonnées hors limites (-90 à 90 pour latitude, -180 à 180 pour longitude)</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Région</mat-label>
              <input matInput type="text" [formControl]="regionCtrl" name="region">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Adresse</mat-label>
              <input matInput type="text" [formControl]="addressCtrl" placeholder="Village/Commune">
            </mat-form-field>
          </div>

          @if (isGoogleMapsReady) {
            <div class="map-container">
              <google-map
                width="100%"
                height="300px"
                [zoom]="mapZoom"
                [center]="(mapCenter | async)!"
                [options]="mapOptions"
                (mapClick)="onMapClick($event)">
                @if (gpsLocation) {
                  <map-marker
                    [position]="{lat: gpsLocation.latitude, lng: gpsLocation.longitude}"
                    [options]="{title: gpsLocation.displayName}">
                  </map-marker>
                }
              </google-map>
            </div>
          } @else {
            <div class="map-loading">
              <mat-spinner diameter="40"></mat-spinner>
              <span>Chargement de la carte...</span>
            </div>
          }
        </div>
      </div>

      <!-- Section Kit de produits -->
      <div class="grid grid--two-fs">
        <!-- Ajout de produits -->
        <div class="card">
          <div class="section-title">
            {{ editMode ? 'Modifier le kit de produits' : 'Définir le kit de produits' }}
          </div>

          <div class="add-product-section">
            <!-- Recherche de produits -->
            <mat-form-field appearance="outline" class="search-field">
              <mat-label>Rechercher un produit</mat-label>
              <input
                matInput
                [formControl]="searchProduct"
                (ngModelChange)="filterProducts()"
                placeholder="Nom ou description...">
              <mat-icon matPrefix>search</mat-icon>
            </mat-form-field>

            <!-- Liste des produits disponibles -->
            <div class="products-list">
              @if (filteredProducts.length === 0) {
                <div class="no-products">
                  <mat-icon>warning</mat-icon>
                  <span>Aucun produit trouvé</span>
                </div>
              }

              @for (product of filteredProducts; track product.id) {
                <div
                  class="product-card"
                  [class.selected]="selectedProduct?.id === product.id"
                  (click)="selectProduct(product)"
                  (keydown)="selectProduct(product)">
                  <div class="product-info">
                    <span class="product-name">{{ product.name }}</span>
                    <span class="product-price">{{ formatPrice(product.price) }}</span>
                  </div>
                  <p class="product-description">{{ product.description }}</p>
                </div>
              }
            </div>

            <!-- Quantité et ajout -->
            @if (selectedProduct) {
              <div class="add-controls">
                <mat-form-field appearance="outline" class="quantity-field">
                  <mat-label>Quantité</mat-label>
                  <input
                    matInput
                    type="number"
                    [formControl]="productQuantity"
                    min="1"
                    placeholder="1">
                  <mat-icon matPrefix>pin</mat-icon>
                </mat-form-field>

                <button
                  class="btn--primary"
                  type="button"
                  (click)="addProductToKit()"
                  [disabled]="!selectedProduct || productQuantity.value <= 0">
                  <mat-icon>add_circle</mat-icon>
                  <span>Ajouter au kit</span>
                </button>
              </div>
            }
          </div>
        </div>

        <!-- Récapitulatif du kit -->
        <div class="card">
          <div class="section-title">
            Récapitulatif du kit
          </div>

          <div class="summary-content">
            <!-- Statistiques -->
            <div class="stats">
              <div class="stat-item">
                <mat-icon>inventory_2</mat-icon>
                <div class="stat-info">
                  <span class="stat-label">Produits</span>
                  <span class="stat-value">{{ getTotalProducts() }}</span>
                </div>
              </div>
              <div class="stat-item total">
                <div class="stat-info">
                  <span class="stat-label">Coût total</span>
                  <span class="stat-value">{{ formatPrice(calculateTotalCost()) }}</span>
                </div>
              </div>
            </div>

            <!-- Liste des produits dans le kit -->
            <div class="kit-products">
              <h3>Produits sélectionnés</h3>

              @if (kitProducts.length === 0) {
                <div class="empty-kit">
                  <mat-icon>inbox</mat-icon>
                  <span>Aucun produit dans le kit</span>
                  <p>Ajoutez des produits depuis la liste ci-contre</p>
                </div>
              }

              @for (kitProduct of kitProducts.controls; track $index; let i = $index) {
                <div class="kit-product-item">
                  <div class="product-header">
                    <span class="product-name">{{ kitProduct.value.product.name }}</span>
                    <button
                      mat-icon-button
                      color="warn"
                      type="button"
                      (click)="removeProductFromKit(i)"
                      matTooltip="Retirer">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>

                  <div class="product-details">
                    <div class="quantity-control">
                      <button
                        mat-icon-button
                        type="button"
                        (click)="updateProductQuantity(i, kitProduct.value.quantity - 1)"
                        [disabled]="kitProduct.value.quantity <= 1">
                        <mat-icon>remove</mat-icon>
                      </button>
                      <input
                        type="number"
                        [value]="kitProduct.value.quantity"
                        (change)="updateProductQuantity(i, +$any($event.target).value)"
                        min="1"
                        class="quantity-input">
                      <button
                        mat-icon-button
                        type="button"
                        (click)="updateProductQuantity(i, kitProduct.value.quantity + 1)">
                        <mat-icon>add</mat-icon>
                      </button>
                    </div>

                    <div class="product-pricing">
                      <span class="unit-price">{{ formatPrice(kitProduct.value.product.price) }} / unité</span>
                      <span class="total-price">{{ formatPrice(kitProduct.value.totalCost) }}</span>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button
          class="btn btn--primary"
          type="submit"
          [disabled]="plantationForm.invalid || gpsCtrl.invalid || kitProducts.length === 0 || (loading$ | async)"
          (click)="createPlantation()">
          @if (loading$ | async) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            <mat-icon>{{ editMode ? 'save' : 'add' }}</mat-icon>
          }
          <span>{{ editMode ? 'Mettre à jour la plantation' : 'Créer la plantation' }}</span>
        </button>

        @if (editMode) {
          <button
            class="btn btn--secondary"
            type="button"
            (click)="cancel()"
            [disabled]="loading$ | async">
            <mat-icon>cancel</mat-icon>
            <span>Annuler</span>
          </button>
        }
      </div>
    </form>
  </div>
</div>
