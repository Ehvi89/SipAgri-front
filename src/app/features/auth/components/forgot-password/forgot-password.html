<div class="fp-container">
  <!-- Header avec logo et navigation -->
  <app-logo></app-logo>

  <!-- Card principale de réinitialisation -->
  <div class="card main-card" *ngIf="!showSuccessMessage">
    <div class="card-header">
      <h2 class="card-title">
        Réinitialiser le mot de passe
      </h2>
      <p class="card-subtitle">
        Choisissez une méthode pour recevoir un lien ou un code de réinitialisation de votre mot de passe
      </p>
    </div>

    <div class="card-content">
      <form class="form fp-form" [formGroup]="fpForm" (ngSubmit)="sendInstructions()">

        <!-- Champ de saisie -->
        <div class="field-section">
          <mat-form-field
            appearance="outline"
            class="full-width"
            [class.field-error]="getCurrentControl().invalid && (getCurrentControl().touched || isSubmitted)">

            <mat-label>
              {{ selectedMethod === 'EMAIL' ? 'Adresse email' : 'Numéro de téléphone' }}
            </mat-label>

            <!-- Champ email -->
            <input
              *ngIf="selectedMethod === 'EMAIL'"
              matInput
              type="email"
              name="email"
              [formControl]="emailCtrl"
              [placeholder]="currentFieldPlaceholder"
              autocomplete="email"
              required>

            <!-- Champ téléphone -->
            <input
              *ngIf="selectedMethod === 'SMS'"
              matInput
              type="tel"
              name="tel"
              [formControl]="telCtrl"
              [placeholder]="currentFieldPlaceholder"
              autocomplete="tel"
              required>

            <!-- Icône de validation -->
            <mat-icon
              matSuffix
              class="validation-icon success"
              *ngIf="getCurrentControl().valid && getCurrentControl().value">
              check_circle
            </mat-icon>

            <!-- Messages d'erreur -->
            <mat-error *ngIf="getCurrentControl().touched || isSubmitted">
              {{ getFieldErrorMessage() }}
            </mat-error>

            <!-- Indications d'aide -->
            <mat-hint *ngIf="selectedMethod === 'SMS' && !getCurrentControl().errors">
              Format: +225 XX XX XX XX XX ou 0X XX XX XX XX
            </mat-hint>
          </mat-form-field>
        </div>

        <!-- Sélection de la méthode -->
        <div class="method-selection">
          <label class="mb-1">Méthode de récupération</label>
          <div class="method-options flex gap--sm">
            <div
              *ngFor="let method of availableMethods"
              class="method-option"
              [class.selected]="isMethodSelected(method.value)"
              (click)="selectMethod(method.value)"
              [attr.aria-pressed]="isMethodSelected(method.value)"
              role="button"
              tabindex="0"
              (keydown.enter)="selectMethod(method.value)"
              (keydown.space)="selectMethod(method.value)">

              <div class="btn btn--secondary btn--sm flex gap--sm radius-md">
                <mat-icon class="selection-indicator" *ngIf="isMethodSelected(method.value)">
                  check
                </mat-icon>

                <mat-icon class="method-icon">{{ method.icon }}</mat-icon>
                <div class="method-info">
                  <span class="method-label">{{ method.label }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="form-row actions">
          <div class="btn-group">
            <a routerLink="/auth/login">Retour à la connexion</a>

            <button
              type="submit"
              class="btn btn--primary btn--send"
              [disabled]="!isFormValid || (isLoading | async)"
              [class.loading]="isLoading | async">

              <mat-spinner
                diameter="20"
                *ngIf="isLoading | async">
              </mat-spinner>

              <i *ngIf="!(isLoading | async)" class='far fa-paper-plane'></i>

              <span class="btn-text">
                {{ (isLoading | async) ? 'Envoi...' : 'Envoyer les instructions' }}
              </span>
            </button>
          </div>
        </div>
      </form>

      <!-- Informations supplémentaires -->
      <div class="additional-info">
        <div class="info-content">
          <h4>Que se passe-t-il ensuite ?</h4>
          <ul class="info-steps">
            <li *ngIf="selectedMethod === 'EMAIL'">
              Vous recevrez un email avec un lien sécurisé
            </li>
            <li *ngIf="selectedMethod === 'SMS'">
              Vous recevrez un SMS avec un code de vérification
            </li>
            <li>Suivez les instructions pour créer un nouveau mot de passe</li>
            <li>Connectez-vous avec votre nouveau mot de passe</li>
          </ul>
        </div>

        <mat-divider></mat-divider>

          <!-- Aide -->
        <div class="card-footer">
          <small>
            Si vous ne parvenez pas à récupérer votre compte,
            <a routerLink="#" class="help-link">contactez notre support</a>
            pour obtenir de l'assistance.
          </small>
        </div>
      </div>
    </div>

    <!-- Barre de progression pour le chargement -->
    <mat-progress-bar
      *ngIf="isLoading | async"
      mode="indeterminate"
      class="loading-bar">
    </mat-progress-bar>
  </div>

  <!-- Messages de sécurité -->
  <div class="security-notice card">
    <div class="card-header">
      <h4 class="card-title">Sécurité</h4>
    </div>
    <div class="card-content flex flex--column flex--center">
      <mat-icon class="security-icon">security</mat-icon>
      <p class="text--center">
        Pour votre sécurité, le lien ou code de réinitialisation expirera dans 15 minutes.
        Assurez-vous de l'utiliser rapidement.
      </p>
    </div>
  </div>
</div>
